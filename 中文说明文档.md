# MacOS 按键音效应用 - 中文说明文档

## 🎯 项目简介

这是一款专为 macOS 设计的桌面应用程序，主要功能是实时监听用户的键盘输入，并在每次按键时播放提示音效。应用采用 Rust 语言开发，具有高性能和低内存占用的特点。

## ✨ 主要功能

- **实时键盘监听**：后台运行，监听所有键盘按键事件
- **音效播放**：每次按键时播放自定义音效文件
- **轻量级设计**：低 CPU 和内存占用，不影响系统性能
- **易于分发**：支持打包为标准的 macOS .app 应用和 .dmg 安装包

## 🛠 技术栈

- **开发语言**：Rust
- **键盘监听**：rdev 库
- **音频播放**：rodio 库
- **应用打包**：cargo-bundle
- **安装包制作**：create-dmg

## 📋 系统要求

- macOS 10.12 或更高版本
- 需要授予"辅助功能"权限以监听键盘事件

## 🚀 快速开始

### 1. 环境准备

确保已安装以下工具：

```bash
# 安装 Rust（如果尚未安装）
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
source "$HOME/.cargo/env"

# 安装打包工具
cargo install cargo-bundle

# 安装 DMG 制作工具（需要 Node.js）
npm install -g create-dmg
```

### 2. 编译和运行

```bash
# 编译项目
cargo build --release

# 直接运行测试
cargo run --release
```

### 3. 授予权限

首次运行时，macOS 会提示需要辅助功能权限：

1. 运行应用后会弹出权限请求对话框
2. 打开"系统偏好设置" → "安全性与隐私" → "隐私" → "辅助功能"
3. 点击锁图标解锁设置
4. 添加您的应用到允许列表中
5. 重新启动应用

## 📦 打包流程详解

### 方法一：使用自动化脚本（推荐）

项目包含了一个自动化构建脚本，一键完成所有打包步骤：

```bash
# 给脚本执行权限
chmod +x build.sh

# 运行自动化构建
./build.sh
```

脚本会自动完成以下步骤：

1. 清理之前的构建文件
2. 编译 Release 版本
3. 安装必要的打包工具
4. 创建 .app 应用包
5. 生成 .dmg 安装包

### 方法二：手动打包步骤

#### 步骤 1：编译 Release 版本

```bash
# 激活 Rust 环境
source "$HOME/.cargo/env"

# 清理旧文件
cargo clean

# 编译优化版本
cargo build --release
```

#### 步骤 2：创建 macOS 应用包

```bash
# 安装 cargo-bundle（如果尚未安装）
cargo install cargo-bundle

# 打包为 .app 应用
cargo bundle --release
```

成功后，应用包将位于：

```
target/release/bundle/osx/MacOS Key Sound.app
```

#### 步骤 3：创建 DMG 安装包

```bash
# 创建输出目录
mkdir -p dist

# 生成 DMG 文件
create-dmg 'target/release/bundle/osx/MacOS Key Sound.app' \
  --overwrite \
  --dmg-title="MacOS Key Sound" \
  dist/
```

DMG 文件将生成在：

```
dist/MacOS Key Sound.dmg
```

## 🔧 自定义配置

### 更换音效文件

1. 将您的音效文件放入 `assets/` 目录
2. 重命名为 `sound.mp3`（或修改代码中的文件路径）
3. 支持格式：WAV、MP3、OGG
4. 建议音效时长：0.1-0.5 秒

### 修改应用信息

编辑 `Cargo.toml` 文件中的打包配置：

```toml
[package.metadata.bundle]
name = "您的应用名称"
identifier = "com.yourcompany.your-app"
version = "1.0.0"
copyright = "版权信息"
```

## 📱 分发和安装

### 给用户的安装说明

1. **下载**：用户下载 `.dmg` 文件
2. **挂载**：双击 DMG 文件挂载磁盘映像
3. **安装**：将应用拖拽到"应用程序"文件夹
4. **运行**：从启动台或应用程序文件夹启动应用
5. **授权**：首次运行时按提示授予辅助功能权限

### 数字签名（可选，用于分发）

如果需要在 Mac App Store 外分发，建议进行代码签名：

```bash
# 使用开发者证书签名
codesign --force --deep --sign "Developer ID Application: Your Name" \
  "target/release/bundle/osx/MacOS Key Sound.app"

# 公证应用（需要开发者账号）
xcrun notarytool submit "dist/MacOS Key Sound.dmg" \
  --apple-id your-email@example.com \
  --password your-app-password \
  --team-id YOUR_TEAM_ID
```

## 🐛 常见问题解决

### 问题 1：权限被拒绝

**解决方案**：确保已在系统偏好设置中授予辅助功能权限

### 问题 2：找不到音效文件

**解决方案**：检查 `assets/sound.mp3` 是否存在，文件格式是否支持

### 问题 3：编译失败

**解决方案**：

```bash
# 更新 Rust 工具链
rustup update

# 清理并重新编译
cargo clean
cargo build --release
```

### 问题 4：DMG 创建失败

**解决方案**：

```bash
# 安装或更新 create-dmg
npm install -g create-dmg

# 检查 .app 文件是否正确生成
ls -la target/release/bundle/osx/
```

## 📝 开发说明

### 项目结构

```
rust-key/
├── src/
│   └── main.rs              # 主程序代码
├── assets/
│   ├── sound.mp3            # 音效文件
│   └── sound_readme.txt     # 音效说明
├── Cargo.toml               # 项目配置
├── build.sh                 # 自动化构建脚本
├── BUILD_INSTRUCTIONS.md    # 英文构建说明
├── 中文说明文档.md           # 本文档
└── README.md                # 项目需求说明
```

### 核心代码逻辑

1. **初始化音频系统**：创建音频输出流和播放器
2. **监听键盘事件**：使用 rdev 库监听全局按键
3. **播放音效**：在新线程中异步播放音效文件
4. **错误处理**：优雅处理文件缺失和音频错误

## 🔄 后续扩展功能

- 支持多种音效选择
- 音量调节功能
- 特定按键自定义音效
- 系统托盘图标和菜单
- 开机自启动选项

## 📞 技术支持

如遇到问题，请检查：

1. 系统权限设置
2. 音效文件完整性
3. Rust 工具链版本
4. macOS 版本兼容性

---

**注意**：此应用仅用于学习和个人使用。在企业环境中使用前，请确保符合相关安全策略。
